#set the OS start the multi-user mode
systemctl set-default multi-user.target

#disable SELinux
SELINUX=disabled

#disable IPv6
vi /etc/sysctl.conf
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1

#Fix ssh login slow issue
vi /etc/ssh/sshd_config
# add this line
UseDNS no

#set hostname and set hosts file
hostnamectl set-hostname gene-1
hostnamectl set-hostname gene-2
hostnamectl set-hostname gene-3
hostnamectl set-hostname gene-4

vi /etc/hosts
192.168.1.201 gene-1
192.168.1.202 gene-2
192.168.1.203 gene-3
192.168.1.204 gene-4

#create lvm on two 8T disks
yum install system-storage-manager
ssm create --fs xfs -p data -n data_volume /dev/sdb /dev/sdc
vi /etc/fstab
/dev/data/data_volume   /home                 xfs     defaults        0 0

#reload the fstab
mount -a

yum -y install epel-release
wget http://build.openhpc.community/OpenHPC:/1.3/CentOS_7/x86_64/ohpc-release-1.3-1.el7.x86_64.rpm
rpm -ivh ohpc-release-1.3-1.el7.x86_64.rpm

#create ssh key
ssh-keygen -t rsa -b 4096
ssh-copy-id -i ~/.ssh/id_rsa.pub root@gene-1
ssh-copy-id -i ~/.ssh/id_rsa.pub root@gene-2
ssh-copy-id -i ~/.ssh/id_rsa.pub root@gene-3
ssh-copy-id -i ~/.ssh/id_rsa.pub root@gene-4

#change the firewall setting
firewall-cmd --permanent --zone=internal --change-interface=eno1

firewall-cmd --permanent --zone=internal --add-port=6817/udp
firewall-cmd --permanent --zone=internal --add-port=6817/tcp
firewall-cmd --permanent --zone=internal --add-port=6818/tcp
firewall-cmd --permanent --zone=internal --add-port=6818/udp
firewall-cmd --permanent --zone=internal --add-port=7321/tcp
firewall-cmd --permanent --zone=internal --add-port=7321/udp
firewall-cmd --reload


Node-1(Master+Compute)
yum -y install ohpc-slurm-server
vi /etc/slurm/slurm.conf
ControlMachine=gene-1
NodeName=gene-[1-4] Sockets=1 CoresPerSocket=68 ThreadsPerCore=4 State=UNKNOWN
yum install ohpc-base
yum install ohpc-base-compute

#start NTP server
systemctl enable ntpd.service
systemctl restart ntpd

Node-2/3/4(Compute)
yum install ohpc-base
yum install ohpc-base-compute
yum install ohpc-slurm-client

#config the NTP Server
vi /etc/ntpd.conf
server gene-1
systemctl enable ntpd.service
systemctl restart ntpd



scp /etc/slurm/slurm.conf root@gene-2:/etc/slurm/slurm.conf
scp /etc/slurm/slurm.conf root@gene-3:/etc/slurm/slurm.conf
scp /etc/slurm/slurm.conf root@gene-4:/etc/slurm/slurm.conf

dd if=/dev/random bs=1 count=1024 >/etc/munge/munge.key
scp /etc/munge/munge.key root@gene-2:/etc/munge/munge.key
scp /etc/munge/munge.key root@gene-3:/etc/munge/munge.key
scp /etc/munge/munge.key root@gene-4:/etc/munge/munge.key


# Start slurm clients on host hosts
systemctl enable munge
systemctl enable slurmctld
systemctl start munge
systemctl start slurmctld

# Start slurm clients on compute hosts
[sms]# pdsh -w $compute_prefix[1-4] systemctl start slurmd
